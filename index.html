<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0b0b0b">
<title>Realm — Minecraft Mini App</title>
<style>
:root {
  --bg: #0e0e0e;
  --surface: #141414;
  --text: #F2F2F2;
  --subtitle: #9a9a9a;
  --stroke: #222222;
  --radius: 14px;
}

html {
  background: var(--bg) !important;
}

body {
  margin: 0;
  min-height: 100dvh;
  max-height: 100dvh;
  overflow: hidden;
  background: var(--bg) !important;
  background-color: var(--bg) !important;
  color: var(--text);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: calc(10px + env(safe-area-inset-top)) calc(12px + env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));
}

body.no-scroll {
  overflow: hidden;
  touch-action: none;
}

a.btn:link,
a.btn:visited,
a.btn:hover,
a.btn:active {
  color: var(--text);
}

h2 {
  margin: 0 0 10px 0;
  font-size: clamp(17px, 3.6vw, 18px);
  font-weight: 500;
}

p {
  font-size: clamp(13px, 3.2vw, 14px);
  line-height: 1.5;
  color: var(--subtitle);
  margin: 6px 0;
}

.btn {
  width: 100%;
  max-width: 260px;
  display: block;
  text-align: center;
  padding: 12px;
  border-radius: 10px;
  background: var(--surface) !important;
  border: 1px solid var(--stroke) !important;
  box-shadow: none !important;
  -webkit-appearance: none;
  appearance: none;
  color: var(--text);
  text-decoration: none;
  font-weight: 500;
  font-size: clamp(14px, 3.4vw, 15.5px);
  margin: 10px auto 0 auto;
  transition: transform .18s ease, border-color .18s ease, background .18s ease, color .18s ease, opacity .18s ease;
  transform: translateY(0);
}

.btn:hover {
  border-color: var(--text);
  transform: translateY(-1px) scale(1.01);
}

.btn:active {
  transform: translateY(0) scale(0.985);
  opacity: 0.94;
}

.profile {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 12px;
}

.welcome {
  margin-top: 0;
  font-size: clamp(24px, 5vw, 28px);
  font-weight: 700;
  text-align: center;
  margin-bottom: 4px;
}

.server-info {
  margin-top: 0;
  font-size: clamp(12.4px, 3vw, 13.4px);
  line-height: 1.4;
  color: var(--subtitle);
  text-align: center;
  margin-bottom: 26px;
  max-width: 460px;
}

.logo-img {
  --tilt-x: 0px;
  --tilt-y: 0px;
  --tilt-scale: 1;
  --tilt-rot: 0deg;
  width: min(330px, 92vw);
  height: 196px;
  object-fit: contain;
  border-radius: 12px;
  margin: 0 auto 6px auto;
  display: block;
  transform: translateX(10px) translate(var(--tilt-x), var(--tilt-y)) rotate(var(--tilt-rot)) scale(var(--tilt-scale));
  transition: transform .2s ease, filter .2s ease;
  will-change: transform;
}

.logo-img:hover {
  filter: drop-shadow(0 4px 12px rgba(0,0,0,0.28));
}

.text-link {
  color: var(--text);
  text-decoration: none;
  border-bottom: 2px solid rgba(255,255,255,0.95);
  padding-bottom: 0;
  font-weight: 600;
  display: inline-block;
  transform-origin: center bottom;
  cursor: pointer;
  transition: color .2s ease, border-color .2s ease, opacity .2s ease;
}

.text-link:hover {
  color: var(--text);
  border-color: rgba(255,255,255,0.7);
  opacity: 0.92;
}

.text-link.small {
  font-size: clamp(13px, 3.2vw, 13.5px);
}

.muted {
  color: var(--subtitle);
}

.rocket-video {
  display: inline-block;
  width: 22px;
  height: 22px;
  margin-left: 4px;
  vertical-align: -4px;
  object-fit: contain;
  pointer-events: none;
}

.inline-gap {
  margin-left: 4px;
}

.divider {
  width: 100%;
  height: 1px;
  background: var(--stroke);
  margin: 10px 0;
}

.meta {
  text-align: center;
  opacity: 0.6;
  font-size: clamp(12px, 3vw, 13px);
}

.icon-row {
  display: flex;
  justify-content: center;
  gap: 14px;
}

.icon-button {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #2A2A2A;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  transition: transform .16s ease, background .16s ease;
}

.icon-button:hover {
  background: #3A3A3A;
  transform: translateY(-1px);
}

.icon-button:active {
  transform: translateY(0) scale(0.97);
}

.payment-row {
  display: flex;
  justify-content: center;
  gap: 14px;
  padding: 26px 0;
}

.payment-button {
  --tilt-x: 0px;
  --tilt-y: 0px;
  --tilt-scale: 1;
  --tilt-rot: 0deg;
  width: 48px;
  height: 48px;
  border-radius: 16px;
  background: #4E00CE;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  transform: translate(var(--tilt-x), var(--tilt-y)) rotate(var(--tilt-rot)) scale(var(--tilt-scale));
  transition: transform .18s ease, opacity .18s ease, box-shadow .18s ease;
  will-change: transform;
}

.payment-button img {
  width: 48px;
  height: 48px;
  border-radius: 12px;
}

.payment-button:hover {
  opacity: 0.92;
  box-shadow: 0 6px 16px rgba(78, 0, 206, 0.22);
}

.payment-button:active {
  --tilt-scale: 0.97;
  box-shadow: 0 3px 10px rgba(78, 0, 206, 0.18);
}

/* Modal styling */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100dvh;
  backdrop-filter: blur(6.4px);
  -webkit-backdrop-filter: blur(6.4px);
  background: rgba(0,0,0,0.35);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .35s ease, backdrop-filter .35s ease, background .35s ease;
  z-index: 10;
}

.modal.hidden {
  opacity: 0;
  pointer-events: none;
}

.modal.active {
  opacity: 1;
  pointer-events: auto;
}

.modal-box {
  background: #161616;
  border: none;
  border-radius: 22px 22px 0 0;
  width: 100%;
  max-width: 360px;
  padding: 14px 18px calc(20px + env(safe-area-inset-bottom)) 18px;
  text-align: center;
  box-shadow: 0 -4px 24px rgba(0,0,0,0.35);
  transform: translateY(100%);
}

.modal.active .modal-box {
  animation: slideUp .35s ease forwards;
}

.modal.closing .modal-box {
  animation: slideDown .35s ease forwards;
}

.modal-title {
  font-size: clamp(18px, 4.8vw, 21px);
  font-weight: 800;
  margin: 6px 0 10px 0;
  display: block;
}

.modal-text {
  font-size: clamp(14px, 3.8vw, 15px);
  font-weight: 500;
  color: var(--text);
  margin: 0 0 14px 0;
  text-align: left;
  line-height: 1.6;
}
.modal-text strong {
  color: var(--text);
}
.modal-text.info-text {
  color: var(--subtitle);
}
.modal-text a {
  color: var(--text);
  text-decoration: none;
  border-bottom: 2px solid rgba(255,255,255,0.95);
  padding-bottom: 0;
  font-weight: 600;
}
.modal-text .muted {
  color: var(--subtitle);
}
button.text-link {
  background: none;
  border: none;
  border-bottom: 2px solid rgba(255,255,255,0.95);
  padding: 0;
  font: inherit;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  text-decoration: none;
}
button.text-link:focus-visible {
  outline: 2px solid var(--text);
  outline-offset: 3px;
}

.modal-header {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding-left: 4px;
  margin-bottom: 10px;
}

.modal-close {
  position: absolute;
  right: 0;
  top: 0;
  background: #2A2A2A;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  display: flex;
  justify-content: center;
  align-items: center;
  border: none;
  color: #fff;
  cursor: pointer;
  transition: background .2s ease;
}

.modal-close:hover {
  background: #3A3A3A;
}

.modal-inner {
  background: #212121;
  padding: 14px;
  border-radius: 14px;
}

#donateModal .modal-box {
  padding: 12px 14px calc(16px + env(safe-area-inset-bottom)) 14px;
  border-radius: 18px;
}

#donateModal .modal-inner {
  padding: 12px;
}

#donateModal .payment-row {
  padding: 12px 0 8px;
}

@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes slideDown {
  from { transform: translateY(0); opacity: 1; }
  to { transform: translateY(100%); opacity: 0; }
}

@keyframes link-wiggle {
  0% { transform: translate(0, 0); }
  50% { transform: translate(0.9px, -1.6px); }
  100% { transform: translate(-0.9px, -0.6px); }
}

.dev-toast {
  position: fixed;
  left: 50%;
  bottom: calc(16px + env(safe-area-inset-bottom));
  transform: translate(-50%, 18px) scale(0.96);
  filter: blur(2px);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(20, 20, 20, 0.94);
  border: 1px solid #2a2a2a;
  box-shadow: 0 10px 30px rgba(0,0,0,0.38);
  opacity: 0;
  pointer-events: none;
  transition:
    opacity .18s ease,
    transform .24s cubic-bezier(0.22, 0.61, 0.36, 1),
    filter .2s ease;
  z-index: 20;
  will-change: transform, opacity, filter;
}

.dev-toast.visible {
  opacity: 1;
  transform: translate(-50%, 0) scale(1);
  filter: blur(0);
  pointer-events: auto;
  animation: toast-bounce .46s cubic-bezier(0.25, 0.9, 0.3, 1.35);
}

.dev-toast__text {
  font-size: clamp(13.5px, 3.4vw, 14.5px);
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
}

.dev-toast__img {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  object-fit: cover;
}

@media (max-width: 380px) {
  .server-info {
    font-size: 12.2px;
    line-height: 1.35;
  }
}

@keyframes toast-bounce {
  0% {
    transform: translate(-50%, 18px) scale(0.9);
    filter: blur(3px);
  }
  60% {
    transform: translate(-50%, -3px) scale(1.02);
    filter: blur(0.4px);
  }
  100% {
    transform: translate(-50%, 0) scale(1);
    filter: blur(0);
  }
}

.page-content {
  position: relative;
  z-index: 1;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.snow-canvas {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100dvh;
  pointer-events: none;
  z-index: 0;
  opacity: 0.88;
  filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
}
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

  <canvas id="snowCanvas" class="snow-canvas" aria-hidden="true"></canvas>

  <div class="page-content">
    <div class="profile">
      <img class="logo-img" src="3ng.png" alt="realm smp logo" />
      <h2 class="welcome">realm smp</h2>
      <p class="server-info">сервер вдохновленный приколами FreakLenda и Мафаньки<br>без приватов и прочей хуйни =)</p>
    </div>

    <a class="btn" href="#" role="button" data-modal-target="playModal">как поиграть???</a>
    <a class="btn" href="#" role="button" data-modal-target="infoModal">полная инфа и правила</a>
    <a class="btn" href="#" role="button" data-modal-target="donateModal">поддержать проект</a> <!-- Open modal --> <!-- ЮMoney integration later -->
  </div>

  <!-- Modal: play -->
  <div id="playModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="playModalTitle">
    <div class="modal-box">
      <div class="modal-header">
        <span class="modal-title" id="playModalTitle">как поиграть???</span>
        <button class="modal-close" type="button" data-close-modal>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-inner">
        <p class="modal-text">
          <strong>1.</strong> подай заявку в <button type="button" class="text-link small dev-action" data-dev-action="bot">боте</button>
          <span class="muted inline-gap">заявки принимаются автоматом в течение 48 часов</span><br><br>
          <strong>2.</strong> скачай <button type="button" class="text-link small dev-action" data-dev-action="build">сборку</button>
          <span class="muted inline-gap">это минимальная сборка для игры на сервере</span><br><br>
          <strong>3.</strong> залетай играть <img class="rocket-video" src="rocket.webp" alt="" aria-hidden="true"><br><br>
          если какие-то проблемы со сборкой или анкетой — <a href="https://t.me/RealmSMPSupport_bot" class="text-link small external-link" rel="noopener noreferrer">пиши в поддержку</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Modal: info -->
  <div id="infoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
    <div class="modal-box">
      <div class="modal-header">
        <span class="modal-title" id="infoModalTitle">полная инфа и правила</span>
        <button class="modal-close" type="button" data-close-modal>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-inner">
        <p class="modal-text info-text">
          <strong>Инфа:</strong><br>
          версия 1.21.8, <a href="https://telegra.ph/polnyj-spisok-vseh-modov-12-02" class="text-link external-link" rel="noopener noreferrer">список модов</a>, ванилла без приватов<br><br>
          <strong>Мотив:</strong><br>
          создать проект, на котором можно лампово поиграть, найти друзей и завести контента<br><br>
          <strong>Нельзя:</strong><br>
          любые читы, запретки твича и ютуба, реклама, гриф без разбирательств (только ради контента)<br><br>
          
<strong><a href="https://telegra.ph/Vsya-infa-i-pravila-12-02" class="text-link external-link" rel="noopener noreferrer">вся подробная информация без обрезок</a></strong>
        </p>
        <div class="divider"></div>
        <div class="meta">
          <div class="icon-row">
            <!-- Telegram Icon --><a href="https://t.me/realm_smp" class="icon-button external-link" rel="noopener noreferrer">
              <svg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M21.5 3.5L2.5 10.5C1.5 10.9 1.6 12.2 2.6 12.5L9 14.5L11 21C11.3 22 12.6 22 13 21.1L15.5 15.5L20 19C20.9 19.7 22.2 19.2 22.5 18.1L24 4.5C24.3 3.3 22.9 2.4 21.5 3.5Z' fill='white'/></svg>
            </a>
            <!-- Discord Icon -->
            <a href="https://discord.gg/W2ePNufkDf" class="icon-button external-link" rel="noopener noreferrer" data-dev-block="discord">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.317 4.3698C18.99 3.7638 17.575 3.3328 16.102 3.0928C15.9005 3.45822 15.709 3.84008 15.53 4.2368C13.997 4.0128 12.463 4.0128 10.931 4.2368C10.752 3.84008 10.56 3.45822 10.359 3.0928C8.88597 3.3338 7.47097 3.7648 6.14397 4.3708C2.88497 9.0418 2.04997 13.5918 2.38097 18.0878C4.08197 19.3408 5.90997 20.2398 7.83297 20.8178C8.33097 20.0708 8.76897 19.2778 9.13797 18.4508C8.33097 18.2488 7.55897 17.9658 6.82597 17.6048C7.01045 17.4792 7.18944 17.3454 7.36197 17.2038C11.258 19.0038 15.585 19.0038 19.481 17.2038C19.654 17.3454 19.832 17.4792 20.015 17.6048C19.282 17.9668 18.51 18.2498 17.703 18.4518C18.074 19.2788 18.511 20.0708 19.009 20.8168C20.936 20.2388 22.764 19.3398 24.464 18.0868C24.84 13.4968 23.711 8.9698 20.317 4.3698ZM8.80297 14.6628C7.74197 14.6628 6.88297 13.6828 6.88297 12.4578C6.88297 11.2328 7.72197 10.2528 8.80297 10.2528C9.88397 10.2528 10.742 11.2328 10.722 12.4578C10.722 13.6828 9.88397 14.6628 8.80297 14.6628ZM15.197 14.6628C14.136 14.6628 13.277 13.6828 13.277 12.4578C13.277 11.2328 14.115 10.2528 15.197 10.2528C16.278 10.2528 17.137 11.2328 17.117 12.4578C17.117 13.6828 16.278 14.6628 15.197 14.6628Z"/>
              </svg>
            </a>
            <!-- TikTok Icon -->
            <a href="https://www.tiktok.com/@realm__smp" class="icon-button external-link" rel="noopener noreferrer">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.5 3h-3v13a2.5 2.5 0 1 1-2.5-2.5h1.5V10H10a5 5 0 1 0 5.5 5V9.28c.81.77 1.87 1.35 3 1.53V7.7c-.74-.14-1.41-.49-2-.99-.94-.79-1.5-1.91-1.5-3.71Z"/>
              </svg>
            </a>
            <!-- Owner TG Icon (crown) --><a href="https://t.me/sdk_net" class="icon-button external-link" rel="noopener noreferrer">
              <svg width='18' height='18' viewBox='0 0 24 24' fill='white' xmlns='http://www.w3.org/2000/svg'><path d='M5 20L4 10L8 13L12 7L16 13L20 10L19 20H5ZM12 4L9.5 9L12 7L14.5 9L12 4Z'/></svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: donate -->
  <div id="donateModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="donateModalTitle">
    <div class="modal-box">
      <div class="modal-header">
        <span class="modal-title" id="donateModalTitle">выберите способ перевода</span>
        <button class="modal-close" type="button" data-close-modal>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-inner">
        <div class="payment-row">
          <a href="https://yoomoney.ru/to/4100119373222814" class="payment-button external-link" rel="noopener noreferrer">
            <img src="4.png" alt="YuMoney" width="28" height="28" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="devToast" class="dev-toast" role="status" aria-live="polite">
    <span class="dev-toast__text">ещё в разработке</span>
    <img class="dev-toast__img" src="2.png" alt="ещё в разработке" width="48" height="48" />
  </div>

<script>
  const root = document.documentElement;
  const tg = window.Telegram?.WebApp;
  const hasTelegram = Boolean(tg);
  let activeModal = null;
  let toastTimer = null;
  const fixedPalette = {
    '--bg': '#0e0e0e',
    '--surface': '#141414',
    '--text': '#F2F2F2',
    '--subtitle': '#9a9a9a',
    '--stroke': '#222222',
  };

  const modals = Array.from(document.querySelectorAll('.modal'));
  const openModalButtons = document.querySelectorAll('[data-modal-target]');
  const closeModalButtons = document.querySelectorAll('[data-close-modal]');
  const devBlockedLinks = document.querySelectorAll('[data-dev-block]');
  const externalLinks = document.querySelectorAll('.external-link:not([data-dev-block])');
  const devToast = document.getElementById('devToast');
  const devToastText = devToast?.querySelector('.dev-toast__text');
  const devActionButtons = document.querySelectorAll('.dev-action');

  const audioManager = (() => {
    let ctx = null;
    let buffers = {};
    let loading = null;
    let unlocked = false;

    const fallback = {
      click: new Audio('click.mp3'),
      deny: new Audio('deny.mp3'),
    };
    Object.values(fallback).forEach((a) => {
      a.preload = 'auto';
    });

    const playFallback = (name, volume = 1) => {
      const a = fallback[name];
      if (!a) return;
      try {
        a.currentTime = 0;
        a.volume = volume;
        const p = a.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
      } catch (_) {
        /* ignore */
      }
    };

    const loadBuffer = async (url) => {
      if (!ctx) return null;
      const res = await fetch(url);
      const arr = await res.arrayBuffer();
      return ctx.decodeAudioData(arr);
    };

    const ensureContext = () => {
      if (ctx) return ctx;
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      return ctx;
    };

    const primeFallback = () => {
      Object.values(fallback).forEach((a) => {
        const restore = () => {
          a.pause();
          a.currentTime = 0;
          a.muted = false;
        };
        a.muted = true;
        a.volume = 0;
        const p = a.play();
        if (p && typeof p.then === 'function') p.then(restore).catch(restore);
        else restore();
      });
    };

    const unlock = async () => {
      if (unlocked) return;
      unlocked = true;
      try {
        ensureContext();
        await ctx.resume();
        if (!loading) {
          loading = Promise.all([
            loadBuffer('click.mp3'),
            loadBuffer('deny.mp3'),
          ]).then(([clickBuf, denyBuf]) => {
            buffers = { click: clickBuf, deny: denyBuf };
          }).catch(() => {
            buffers = {};
          });
        }
      } catch (_) {
        buffers = {};
      } finally {
        primeFallback();
      }
    };

    const play = (name, volume = 1) => {
      const buffer = buffers[name];
      if (buffer && ctx && ctx.state !== 'closed') {
        try {
          const source = ctx.createBufferSource();
          source.buffer = buffer;
          const gain = ctx.createGain();
          gain.gain.value = volume;
          source.connect(gain).connect(ctx.destination);
          source.start(0);
          return;
        } catch (_) {
          /* fallback below */
        }
      }
      playFallback(name, volume);
    };

    const attachUnlock = () => {
      const handler = () => unlock();
      window.addEventListener('pointerdown', handler, { passive: true, once: true });
      window.addEventListener('touchstart', handler, { passive: true, once: true });
      window.addEventListener('click', handler, { passive: true, once: true });
    };

    attachUnlock();

    return { play, unlock };
  })();

  function enforceFixedTheme() {
    Object.entries(fixedPalette).forEach(([key, value]) => {
      root.style.setProperty(key, value);
    });
    document.documentElement.style.setProperty('background', 'var(--bg)', 'important');
    document.body.style.setProperty('background', 'var(--bg)', 'important');
    document.body.style.setProperty('background-color', 'var(--bg)', 'important');
    const themeMeta = document.querySelector('meta[name="theme-color"]');
    if (themeMeta) themeMeta.setAttribute('content', fixedPalette['--bg']);
    tg?.setBackgroundColor?.(fixedPalette['--bg']);
  }

  function enforceButtons() {
    const btns = document.querySelectorAll('.btn');
    btns.forEach((btn) => {
      btn.style.setProperty('background-color', 'var(--surface)', 'important');
      btn.style.setProperty('border-color', 'var(--stroke)', 'important');
      btn.style.setProperty('color', 'var(--text)', 'important');
      btn.style.setProperty('box-shadow', 'none', 'important');
      btn.style.setProperty('-webkit-appearance', 'none', 'important');
      btn.style.setProperty('appearance', 'none', 'important');
    });
  }

  function lockScroll() {
    document.body.classList.add('no-scroll');
  }

  function unlockScroll() {
    document.body.classList.remove('no-scroll');
  }

  function openModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;

    if (activeModal && activeModal !== modal) {
      closeModal(activeModal);
    }

    modal.classList.remove('hidden', 'closing');
    modal.classList.add('active');
    activeModal = modal;
    lockScroll();
  }

  function closeModal(modal) {
    if (!modal) return;

    const box = modal.querySelector('.modal-box');
    modal.classList.add('closing');
    modal.classList.remove('active');

    const handleClose = () => {
      if (!modal.classList.contains('closing')) return;
      modal.classList.add('hidden');
      modal.classList.remove('closing');
      if (activeModal === modal) activeModal = null;
      const hasAnyOpen = modals.some(m => m.classList.contains('active'));
      if (!hasAnyOpen) unlockScroll();
      box?.removeEventListener('animationend', handleClose);
    };

    if (box) {
      box.addEventListener('animationend', handleClose, { once: true });
    } else {
      handleClose();
    }
  }

  function openExternal(url) {
    if (!url) return;
    if (hasTelegram && typeof tg.openLink === 'function') {
      tg.openLink(url, { try_instant_view: false });
    } else {
      window.open(url, '_blank', 'noopener,noreferrer');
    }
  }

  function showDevToast(message = 'ещё в разработке') {
    if (!devToast || !devToastText) return;
    audioManager.play('deny', 0.32);
    devToastText.textContent = message;
    devToast.classList.remove('visible');
    void devToast.offsetWidth; // restart transition
    devToast.classList.add('visible');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      devToast.classList.remove('visible');
    }, 1800);
  }

  openModalButtons.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openModal(btn.dataset.modalTarget);
    });
  });

  closeModalButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const modal = btn.closest('.modal');
      closeModal(modal);
    });
  });

  modals.forEach((modal) => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal(modal);
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && activeModal) {
      closeModal(activeModal);
    }
  });

  externalLinks.forEach((link) => {
    link.setAttribute('rel', 'noopener noreferrer');
    link.addEventListener('click', (e) => {
      e.preventDefault();
      openExternal(link.href);
    });
  });

  devBlockedLinks.forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      showDevToast();
    });
  });

  devActionButtons.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      showDevToast();
    });
  });

  const canMagnet = window.matchMedia?.('(hover: hover) and (pointer: fine)')?.matches;

  function attachMagnetEffect(targets, { strength = 3, scale = 1.02, rotFactor = 0.05, ease = 0.16 } = {}) {
    if (!canMagnet) return;
    targets.forEach((el) => {
      if (!el) return;
      let target = { x: 0, y: 0, scale: 1, rot: 0 };
      let current = { ...target };
      let rafId = null;

      const apply = () => {
        el.style.setProperty('--tilt-x', `${current.x.toFixed(3)}px`);
        el.style.setProperty('--tilt-y', `${current.y.toFixed(3)}px`);
        el.style.setProperty('--tilt-scale', current.scale.toFixed(3));
        el.style.setProperty('--tilt-rot', `${current.rot.toFixed(3)}deg`);
      };

      const step = () => {
        current.x += (target.x - current.x) * ease;
        current.y += (target.y - current.y) * ease;
        current.scale += (target.scale - current.scale) * ease;
        current.rot += (target.rot - current.rot) * ease;
        apply();
        const stillMoving =
          Math.abs(target.x - current.x) +
          Math.abs(target.y - current.y) +
          Math.abs(target.scale - current.scale) +
          Math.abs(target.rot - current.rot) > 0.01;
        if (stillMoving) rafId = requestAnimationFrame(step);
        else rafId = null;
      };

      const reset = () => {
        target = { x: 0, y: 0, scale: 1, rot: 0 };
        if (!rafId) rafId = requestAnimationFrame(step);
      };

      el.addEventListener('mouseenter', () => {
        target.scale = scale;
        if (!rafId) rafId = requestAnimationFrame(step);
      });

      el.addEventListener('mousemove', (e) => {
        const rect = el.getBoundingClientRect();
        const relX = (e.clientX - (rect.left + rect.width / 2)) / (rect.width / 2);
        const relY = (e.clientY - (rect.top + rect.height / 2)) / (rect.height / 2);
        const dx = Math.max(-1, Math.min(1, relX)) * strength;
        const dy = Math.max(-1, Math.min(1, relY)) * strength;
        target.x = dx;
        target.y = dy;
        target.rot = -(dx * rotFactor) + (dy * rotFactor * 0.6);
        if (!rafId) rafId = requestAnimationFrame(step);
      });

      el.addEventListener('mouseleave', reset);
      reset();
    });
  }

  attachMagnetEffect([document.querySelector('.logo-img')], { strength: 2.4, scale: 1.018, rotFactor: 0.03, ease: 0.18 });
  attachMagnetEffect(Array.from(document.querySelectorAll('.payment-button')), { strength: 1.8, scale: 1.02, rotFactor: 0.025, ease: 0.18 });

  const playableButtons = [
    ...document.querySelectorAll('.btn'),
    ...document.querySelectorAll('.payment-button'),
    ...document.querySelectorAll('.icon-button'),
    ...document.querySelectorAll('.modal-close'),
    ...document.querySelectorAll('.external-link'),
  ];

  const playClick = () => audioManager.play('click', 0.42);

  playableButtons.forEach((el) => {
    el.addEventListener('click', () => playClick());
  });

  enforceFixedTheme();
  enforceButtons();

  if (hasTelegram) {
    tg.ready();
    tg.expand?.();
    enforceFixedTheme();
    enforceButtons();
    tg.onEvent?.('themeChanged', () => {
      enforceFixedTheme();
      enforceButtons();
    });
  } else {
    console.warn('Telegram WebApp API not available; running in normal browser preview.');
  }

  function initSnow() {
    const canvas = document.getElementById('snowCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const flakes = [];
    const dpr = Math.min(window.devicePixelRatio || 1, 2.5);
    let width = window.innerWidth;
    let height = window.innerHeight;
    let maxFlakes = 0;
    const wind = { value: 0, target: 0, lastShift: performance.now(), cadence: 2200 + Math.random() * 900 };

    function createFlake(startY) {
      const layerChance = Math.random();
      const layer = layerChance > 0.65 ? 'near' : layerChance > 0.3 ? 'mid' : 'far';
      const depth = layer === 'near' ? 1 : layer === 'mid' ? 0.72 : 0.52;
      return {
        x: Math.random() * width,
        y: typeof startY === 'number' ? startY : Math.random() * height,
        r: (0.9 + Math.random() * 2.2) * depth,
        speed: (0.08 + Math.random() * 0.55) * depth,
        drift: (Math.random() - 0.5) * 0.22 * depth,
        sway: Math.random() * Math.PI * 2,
        swaySpeed: (0.0006 + Math.random() * 0.0015) * depth,
        twinklePhase: Math.random() * Math.PI * 2,
        twinkleSpeed: 0.0007 + Math.random() * 0.0013,
        opacity: 0.4 + Math.random() * 0.5,
        depth,
      };
    }

    function resizeSnow() {
      width = window.innerWidth;
      height = window.innerHeight;
      maxFlakes = Math.min(150, Math.floor(width / 4.4));
      canvas.width = Math.floor(width * dpr);
      canvas.height = Math.floor(height * dpr);
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      while (flakes.length < maxFlakes) {
        flakes.push(createFlake(Math.random() * height));
      }
      flakes.length = maxFlakes;
    }

    let lastFrame = performance.now();
    function renderSnow(now) {
      const delta = Math.min(32, now - lastFrame);
      lastFrame = now;
      const driftScale = delta / 16;

      if (now - wind.lastShift > wind.cadence) {
        wind.target = (Math.random() - 0.5) * 0.22;
        wind.lastShift = now;
        wind.cadence = 2200 + Math.random() * 1200;
      }
      wind.value += (wind.target - wind.value) * 0.0016 * delta;

      ctx.clearRect(0, 0, width, height);

      flakes.sort((a, b) => a.depth - b.depth);
      for (let i = 0; i < flakes.length; i++) {
        const flake = flakes[i];
        flake.sway += flake.swaySpeed * delta;
        flake.twinklePhase += flake.twinkleSpeed * delta;
        const swayOffset = Math.sin(flake.sway) * (0.5 + flake.r * 0.035);
        flake.x += swayOffset + (flake.drift + wind.value) * driftScale;
        flake.y += (flake.speed + flake.r * 0.025) * driftScale;

        if (flake.y > height + 10 || flake.x < -12 || flake.x > width + 12) {
          flakes[i] = createFlake(-16);
          continue;
        }

        const flicker = 0.82 + Math.sin(flake.twinklePhase) * 0.18;
        ctx.globalAlpha = Math.min(1, Math.max(0.1, flake.opacity * flicker));
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255, 255, 255, 1)';
        ctx.shadowColor = 'rgba(255, 255, 255, 0.28)';
        ctx.shadowBlur = 4 + flake.r * 2;
        ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      requestAnimationFrame(renderSnow);
    }

    resizeSnow();
    requestAnimationFrame(renderSnow);
    window.addEventListener('resize', resizeSnow);
  }

  initSnow();
</script>

</body>
</html>
